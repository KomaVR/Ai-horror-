<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hollow Estate</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        canvas { width: 100vw; height: 100vh; touch-action: none; }
        #ui {
            position: absolute; top: 10px; left: 10px; color: white;
            font-family: Arial, sans-serif; background: rgba(0,0,0,0.7); padding: 5px;
        }
        #message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 18px; text-align: center; background: rgba(0,0,0,0.7);
            padding: 10px; display: none; max-width: 90%;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="ui">
        Room: <span id="roomName">Foyer</span> | 
        Artifacts: <span id="artifactCount">0</span>/10 | 
        Notes: <span id="noteCount">0</span>
    </div>
    <div id="message"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const roomNameUI = document.getElementById('roomName');
        const artifactCountUI = document.getElementById('artifactCount');
        const noteCountUI = document.getElementById('noteCount');
        const message = document.getElementById('message');

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas });
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Room definitions with lore and content
        const rooms = [
            { id: 'foyer', x: 0, z: 0, color: 0x333333, doors: ['library', 'kitchen', 'study'], objects: [
                { type: 'note', text: '1923, Edwin: "Tonight, we summon eternity."', x: 2, z: -2 }
            ]},
            { id: 'library', x: -15, z: 0, color: 0x442200, doors: ['foyer', 'hallway'], objects: [
                { type: 'puzzle', x: -2, z: -2, clue: 'Arrange books: FEAR', key: 'Edwin’s Journal', state: [false, false, false, false], order: [2, 0, 1, 3] },
                { type: 'note', text: 'Clara: "He’s lost to his books."', x: 2, z: -2 }
            ]},
            { id: 'kitchen', x: 15, z: 0, color: 0x555555, doors: ['foyer', 'dining'], objects: [
                { type: 'search', x: 2, z: -2, key: 'Knife', chance: 0.2 },
                { type: 'note', text: 'Thomas: "I’ll cut through this nightmare."', x: -2, z: 2 }
            ]},
            { id: 'study', x: 0, z: -15, color: 0x332211, doors: ['foyer', 'parlor'], objects: [
                { type: 'note', text: 'Edwin: "Lily’s soul was the price."', x: 2, z: -2, easterEgg: 'xAI logo on wall' }
            ]},
            { id: 'dining', x: 30, z: 0, color: 0x442200, doors: ['kitchen', 'cellar'], objects: [
                { type: 'note', text: 'Servant: "Blood pooled under the chandelier."', x: 0, z: 2 }
            ]},
            { id: 'parlor', x: 15, z: -15, color: 0x223322, doors: ['study', 'greenhouse'], objects: [
                { type: 'search', x: 2, z: -2, key: 'Greenhouse Key', chance: 0.3 },
                { type: 'note', text: 'Clara: "The parlor was my refuge."', x: -2, z: 2 }
            ]},
            { id: 'greenhouse', x: 30, z: -15, color: 0x114422, doors: ['parlor'], objects: [
                { type: 'note', text: 'Clara: "Thorns trapped me here."', x: 2, z: -2, needs: 'Greenhouse Key' }
            ]},
            { id: 'servant', x: -15, z: -15, color: 0x333333, doors: ['foyer'], objects: [
                { type: 'note', text: 'Maid: "Lily’s screams still echo."', x: 0, z: 2 }
            ]},
            { id: 'hallway', x: -15, z: -30, color: 0x333333, doors: ['library', 'bedroom', 'attic'], objects: [
                { type: 'note', text: 'Thomas: "The hallway hides our sins."', x: 2, z: -2 }
            ]},
            { id: 'bedroom', x: -30, z: -30, color: 0x222266, doors: ['hallway'], objects: [
                { type: 'puzzle', x: -2, z: -2, clue: 'Safe code: 1923', key: 'Clara’s Locket', solved: false },
                { type: 'note', text: 'Clara: "My locket holds her last smile."', x: 2, z: -2 }
            ]},
            { id: 'thomasRoom', x: -30, z: -15, color: 0x332211, doors: ['hallway'], objects: [
                { type: 'search', x: 2, z: -2, key: 'Thomas’s Dagger', chance: 0.25 },
                { type: 'note', text: 'Thomas: "I’ll end this curse."', x: -2, z: 2 }
            ]},
            { id: 'lilyRoom', x: -45, z: -30, color: 0x662244, doors: ['hallway'], objects: [
                { type: 'puzzle', x: -2, z: -2, clue: 'Match toys: Bear, Doll, Train', key: 'Lily’s Doll', solved: false },
                { type: 'note', text: 'Lily: "The shadow took my toys."', x: 2, z: -2 }
            ]},
            { id: 'guest', x: -15, z: -45, color: 0x223322, doors: ['hallway'], objects: [
                { type: 'note', text: 'Guest: "I saw her ghost in the mirror."', x: 0, z: 2 }
            ]},
            { id: 'attic', x: -30, z: -45, color: 0x444444, doors: ['hallway'], objects: [
                { type: 'search', x: 0, z: -2, key: 'Broken Mirror', chance: 0.3, needs: 'Crowbar' },
                { type: 'note', text: 'Thomas: "The attic holds our shame."', x: 2, z: 2, easterEgg: 'Grok was our pet' }
            ]},
            { id: 'bathroom', x: -45, z: -15, color: 0x555555, doors: ['hallway'], objects: [
                { type: 'note', text: 'Clara: "Blood filled the tub."', x: 2, z: -2 }
            ]},
            { id: 'balcony', x: -30, z: -60, color: 0x333333, doors: ['hallway'], objects: [
                { type: 'note', text: 'Edwin: "The stars mocked our fate."', x: 0, z: 2 }
            ]},
            { id: 'cellar', x: 45, z: -15, color: 0x111111, doors: ['dining', 'ritual'], objects: [
                { type: 'key', x: 2, z: -2, key: 'Crowbar' },
                { type: 'note', text: 'Servant: "The cellar swallowed our hope."', x: -2, z: 2 }
            ]},
            { id: 'ritual', x: 60, z: -15, color: 0x550000, doors: ['cellar', 'crypt'], objects: [
                { type: 'puzzle', x: 2, z: -2, clue: 'Fill chalice: Blood, Tears, Dust', key: 'Ritual Chalice', solved: false },
                { type: 'note', text: 'Edwin: "The chalice sealed our doom."', x: -2, z: 2 }
            ]},
            { id: 'storage', x: 45, z: -30, color: 0x222222, doors: ['cellar'], objects: [
                { type: 'note', text: 'Thomas: "I hid my dagger here."', x: 2, z: -2 }
            ]},
            { id: 'boiler', x: 60, z: -30, color: 0x333333, doors: ['ritual'], objects: [
                { type: 'note', text: 'Worker: "The shadows danced in the heat."', x: 0, z: 2 }
            ]},
            { id: 'crypt', x: 75, z: -15, color: 0x111111, doors: ['ritual', 'vault'], objects: [
                { type: 'puzzle', x: 2, z: -2, clue: 'Ring’s code: LILY', key: 'Occult Ring', solved: false },
                { type: 'note', text: 'Clara: "Lily’s crypt is a lie."', x: -2, z: 2 }
            ]},
            { id: 'wine', x: 75, z: 0, color: 0x442200, doors: ['cellar'], objects: [
                { type: 'note', text: 'Edwin: "Wine turned to ash."', x: 2, z: -2 }
            ]},
            { id: 'workshop', x: 90, z: -15, color: 0x555555, doors: ['crypt'], objects: [
                { type: 'note', text: 'Thomas: "I forged a blade too late."', x: 2, z: -2, easterEgg: 'xAI graffiti' }
            ]},
            { id: 'vault', x: 75, z: -30, color: 0x111111, doors: ['crypt'], objects: [
                { type: 'secret', x: 2, z: -2, key: 'Wraith’s Shard', clue: '10 notes reveal the truth.' }
            ]},
            { id: 'lair', x: 90, z: -30, color: 0x000000, doors: [], objects: [
                { type: 'note', text: 'Lily: "End it, please..."', x: 0, z: 2 }
            ]}
        ];

        // Build rooms
        const wallMat = new THREE.MeshBasicMaterial({ color: 0x333333, side: THREE.BackSide });
        rooms.forEach(r => {
            const room = new THREE.Mesh(new THREE.BoxGeometry(10, 10, 10), wallMat);
            room.position.set(r.x, 0, r.z);
            scene.add(room);
            r.mesh = room;

            // Add doors
            if (r.doors[0]) {
                const door = new THREE.Mesh(new THREE.PlaneGeometry(2, 4), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
                door.position.set(-4.9, -2, 0);
                room.add(door);
            }
            if (r.doors[1]) {
                const door = new THREE.Mesh(new THREE.PlaneGeometry(2, 4), new THREE.MeshBasicMaterial({ color: 0x0000ff }));
                door.position.set(4.9, -2, 0);
                room.add(door);
            }
            if (r.doors[2]) {
                const door = new THREE.Mesh(new THREE.PlaneGeometry(2, 4), new THREE.MeshBasicMaterial({ color: 0x00ff00 }));
                door.position.set(0, -2, -4.9);
                room.add(door);
            }

            r.objects.forEach(obj => {
                if (obj.type === 'key' || obj.type === 'search' || obj.type === 'puzzle' || obj.type === 'secret') {
                    const mesh = new THREE.Mesh(
                        new THREE.SphereGeometry(0.3, 8, 8),
                        new THREE.MeshBasicMaterial({ color: 0xffff00 })
                    );
                    mesh.position.set(r.x + obj.x, -4, r.z + obj.z);
                    obj.mesh = mesh;
                    scene.add(mesh);
                } else if (obj.type === 'note') {
                    obj.pos = new THREE.Vector3(r.x + obj.x, -4, r.z + obj.z);
                }
            });
        });

        // Wraith and Lily
        const wraith = new THREE.Mesh(
            new THREE.CylinderGeometry(0.5, 0.5, 3, 8),
            new THREE.MeshBasicMaterial({ color: 0x111111 })
        );
        wraith.position.set(15, -4, -15);
        scene.add(wraith);

        const lily = new THREE.Mesh(
            new THREE.SphereGeometry(0.3, 8, 8),
            new THREE.MeshBasicMaterial({ color: 0xaaaaaa })
        );
        lily.position.set(-100, -4, -100); // Hidden initially
        scene.add(lily);

        // Exit door in foyer
        const exitDoor = new THREE.Mesh(
            new THREE.PlaneGeometry(2, 4),
            new THREE.MeshBasicMaterial({ color: 0x550000 })
        );
        exitDoor.position.set(0, -2, 4.9);
        rooms[0].mesh.add(exitDoor);

        // Lighting
        const ambient = new THREE.AmbientLight(0x222222);
        scene.add(ambient);
        const pointLight = new THREE.PointLight(0xaaaaaa, 1, 20);
        pointLight.position.set(0, 0, 0);
        scene.add(pointLight);

        // Player state
        let currentRoom = rooms[0];
        camera.position.set(0, -2, 0);
        let inventory = [];
        let notes = [];
        let wraithSpeed = 0.005;
        let scareTimer = 0;
        let lilyTimer = 0;

        // Touch controls
        let startX, startY;
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const deltaX = e.touches[0].clientX - startX;
            const deltaY = e.touches[0].clientY - startY;
            camera.rotation.y -= deltaX * 0.005;
            const moveSpeed = 0.05;
            const newX = camera.position.x - Math.sin(camera.rotation.y) * (deltaY < -50 ? moveSpeed : deltaY > 50 ? -moveSpeed : 0);
            const newZ = camera.position.z - Math.cos(camera.rotation.y) * (deltaY < -50 ? moveSpeed : deltaY > 50 ? -moveSpeed : 0);
            if (Math.abs(newX - currentRoom.x) < 4 && Math.abs(newZ - currentRoom.z) < 4) {
                camera.position.x = newX;
                camera.position.z = newZ;
            }
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        canvas.addEventListener('touchend', (e) => {
            const x = e.changedTouches[0].clientX / window.innerWidth;
            const y = e.changedTouches[0].clientY / window.innerHeight;
            if (y > 0.8) interact();
            else if (x < 0.33 && currentRoom.doors[0]) goToRoom(currentRoom.doors[0]); // Left (red)
            else if (x > 0.33 && x < 0.66 && currentRoom.doors[1]) goToRoom(currentRoom.doors[1]); // Right (blue)
            else if (x > 0.66 && currentRoom.doors[2]) goToRoom(currentRoom.doors[2]); // Forward (green)
        });

        function interact() {
            currentRoom.objects.forEach(obj => {
                if (obj.mesh && camera.position.distanceTo(obj.mesh.position) < 2) {
                    if (obj.type === 'key') {
                        inventory.push(obj.key);
                        scene.remove(obj.mesh);
                        showMessage(`You found ${obj.key}!`);
                        wraithSpeed += 0.005;
                    } else if (obj.type === 'search') {
                        if (obj.needs && !inventory.includes(obj.needs)) {
                            showMessage(`You need a ${obj.needs}.`);
                        } else if (Math.random() < obj.chance) {
                            inventory.push(obj.key);
                            scene.remove(obj.mesh);
                            showMessage(`You found ${obj.key}!`);
                            wraithSpeed += 0.005;
                        } else {
                            showMessage('Nothing here yet...');
                        }
                    } else if (obj.type === 'puzzle' && !obj.solved) {
                        if (obj.clue.includes('FEAR')) {
                            const idx = Math.floor(Math.random() * 4);
                            obj.state[idx] = true;
                            if (obj.state.every((s, i) => s === (obj.order.indexOf(i) !== -1))) {
                                obj.solved = true;
                                inventory.push(obj.key);
                                scene.remove(obj.mesh);
                                showMessage(`Puzzle solved! Found ${obj.key}.`);
                                wraithSpeed += 0.005;
                            } else if (obj.state.every(s => s)) {
                                obj.state = [false, false, false, false];
                                showMessage('Wrong order. Resetting...');
                            } else {
                                showMessage(obj.clue);
                            }
                        } else if (obj.clue.includes('1923') || obj.clue.includes('toys') || obj.clue.includes('chalice') || obj.clue.includes('LILY')) {
                            obj.solved = true;
                            inventory.push(obj.key);
                            scene.remove(obj.mesh);
                            showMessage(`Puzzle solved! Found ${obj.key}.`);
                            wraithSpeed += 0.005;
                        }
                    } else if (obj.type === 'secret' && notes.length >= 10) {
                        inventory.push(obj.key);
                        scene.remove(obj.mesh);
                        showMessage(`Secret unlocked! Found ${obj.key}.`);
                        goToRoom('lair');
                    }
                } else if (obj.type === 'note' && camera.position.distanceTo(obj.pos) < 2) {
                    showMessage(obj.text);
                    if (!notes.includes(obj.text)) {
                        notes.push(obj.text);
                        noteCountUI.innerText = notes.length;
                    }
                    if (obj.easterEgg) showMessage(obj.easterEgg);
                }
            });
            if (currentRoom.id === 'foyer' && camera.position.distanceTo(exitDoor.position) < 2 && inventory.length >= 10) {
                win();
            }
        }

        function goToRoom(roomId) {
            const newRoom = rooms.find(r => r.id === roomId);
            camera.position.set(newRoom.x, -2, newRoom.z);
            currentRoom = newRoom;
            pointLight.position.set(newRoom.x, 0, newRoom.z);
            roomNameUI.innerText = newRoom.id.charAt(0).toUpperCase() + newRoom.id.slice(1);
            scareTimer = Math.max(scareTimer - 60, 0); // Reduce scare cooldown slightly
        }

        function scare() {
            const scares = [
                'Blood drips from above.',
                'A distant scream pierces the silence.',
                'The walls creak unnaturally.',
                'Something brushes your shoulder.',
                'A shadow flickers in the corner.'
            ];
            showMessage(scares[Math.floor(Math.random() * scares.length)], true);
        }

        function animate() {
            requestAnimationFrame(animate);
            pointLight.intensity = 0.5 + Math.sin(Date.now() * 0.005) * 0.5;

            // Wraith movement
            const targetRoom = rooms[Math.floor(Math.random() * rooms.length)];
            wraith.position.x += (targetRoom.x - wraith.position.x) * wraithSpeed;
            wraith.position.z += (targetRoom.z - wraith.position.z) * wraithSpeed;
            if (Math.random() < 0.05 && scareTimer > 600) {
                wraith.position.set(camera.position.x + 5, -4, camera.position.z + 5);
                showMessage('The Wraith is near!', true);
            }
            if (camera.position.distanceTo(wraith.position) < 1) lose();

            // Lily’s ghost
            lilyTimer++;
            if (lilyTimer > 300 && Math.random() < 0.02) {
                lily.position.set(camera.position.x + 2, -4, camera.position.z + 2);
                const lilyMessages = [
                    'Find my doll...',
                    'It hurts...',
                    'Mommy’s gone...',
                    'Help me escape...'
                ];
                showMessage(lilyMessages[Math.floor(Math.random() * lilyMessages.length)], true);
                lilyTimer = 0;
            } else if (lilyTimer > 60) lily.position.set(-100, -4, -100);

            // Random scares
            scareTimer++;
            if (scareTimer > 120 && Math.random() < 0.01) {
                scare();
                scareTimer = 0;
            }

            renderer.render(scene, camera);
        }

        function showMessage(text, isScare = false) {
            message.innerText = text;
            message.style.color = isScare ? 'red' : 'white';
            message.style.display = 'block';
            setTimeout(() => message.style.display = 'none', 3000);
        }

        function win() {
            const ending = inventory.includes('Wraith’s Shard') ? 'You banished the Wraith and freed the Hollows!' : 'You escaped, but the curse lingers.';
            showMessage(ending);
            setTimeout(() => location.reload(), 2000);
        }

        function lose() {
            showMessage('The Wraith claimed your soul...');
            setTimeout(() => location.reload(), 2000);
        }

        showMessage('Explore the Hollow Estate. Find 10 artifacts to escape.');
        animate();
    </script>
</body>
</html>
