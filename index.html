<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hollow Estate</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        canvas { width: 100vw; height: 100vh; touch-action: none; }
        #ui {
            position: absolute; top: 10px; left: 10px; color: white;
            font-family: Arial, sans-serif; background: rgba(0,0,0,0.7); padding: 5px;
        }
        #message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 18px; text-align: center; background: rgba(0,0,0,0.7);
            padding: 10px; display: none; max-width: 90%;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="ui">Artifacts: <span id="artifactCount">0</span>/10 | Notes: <span id="noteCount">0</span></div>
    <div id="message"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const artifactCountUI = document.getElementById('artifactCount');
        const noteCountUI = document.getElementById('noteCount');
        const message = document.getElementById('message');

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas });
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Extensive room data with lore and content
        const rooms = [
            { id: 'foyer', x: 0, z: 0, color: 0x333333, doors: ['library', 'kitchen', 'study', 'hallway'], objects: [
                { type: 'note', text: '1923, Edwin: "Tonight, we transcend death."', x: 2, z: -2 }
            ]},
            { id: 'library', x: -10, z: 0, color: 0x442200, doors: ['foyer', 'hallway'], objects: [
                { type: 'puzzle', x: -2, z: -2, clue: 'Arrange books: FEAR', key: 'journal', state: [false, false, false, false], order: [2, 0, 1, 3] },
                { type: 'note', text: 'Clara: "Edwin’s madness took Lily from me."', x: 2, z: -2 }
            ]},
            { id: 'kitchen', x: 10, z: 0, color: 0x555555, doors: ['foyer', 'dining'], objects: [
                { type: 'search', x: 2, z: -2, key: 'knife', chance: 0.2 },
                { type: 'note', text: 'Thomas: "I’ll cut the ropes myself if I must."', x: -2, z: 2 }
            ]},
            { id: 'study', x: 0, z: -10, color: 0x332211, doors: ['foyer', 'parlor'], objects: [
                { type: 'note', text: 'Edwin: "The Wraith demands a price—Lily’s soul."', x: 2, z: -2, easterEgg: 'xAI carved on desk' }
            ]},
            { id: 'dining', x: 20, z: 0, color: 0x442200, doors: ['kitchen', 'cellar'], objects: [
                { type: 'note', text: 'Servant: "Blood stained the table that night."', x: 0, z: 2 }
            ]},
            { id: 'parlor', x: 0, z: -20, color: 0x223322, doors: ['study', 'greenhouse'], objects: [
                { type: 'search', x: 2, z: -2, key: 'greenhouseKey', chance: 0.3 },
                { type: 'note', text: 'Clara: "The greenhouse was my sanctuary."', x: -2, z: 2 }
            ]},
            { id: 'greenhouse', x: 10, z: -20, color: 0x114422, doors: ['parlor'], objects: [
                { type: 'note', text: 'Clara: "I tried to flee, but the vines grew thorns."', x: 2, z: -2, needs: 'greenhouseKey' }
            ]},
            { id: 'servant', x: -10, z: -20, color: 0x333333, doors: ['foyer'], objects: [
                { type: 'note', text: 'Maid: "Lily screamed as the shadows took her."', x: 0, z: 2 }
            ]},
            { id: 'hallway', x: -10, z: -10, color: 0x333333, doors: ['library', 'bedroom', 'attic', 'guest'], objects: [] },
            { id: 'bedroom', x: -20, z: -10, color: 0x222266, doors: ['hallway'], objects: [
                { type: 'puzzle', x: -2, z: -2, clue: 'Safe code: 1923', key: 'locket', solved: false },
                { type: 'note', text: 'Clara: "My locket holds her memory."', x: 2, z: -2 }
            ]},
            { id: 'thomasRoom', x: -20, z: 0, color: 0x332211, doors: ['hallway'], objects: [
                { type: 'search', x: 2, z: -2, key: 'dagger', chance: 0.25 },
                { type: 'note', text: 'Thomas: "I’ll kill it or die trying."', x: -2, z: 2 }
            ]},
            { id: 'lilyRoom', x: -30, z: -10, color: 0x662244, doors: ['hallway'], objects: [
                { type: 'puzzle', x: -2, z: -2, clue: 'Match toys: Bear, Doll, Train', key: 'doll', solved: false },
                { type: 'note', text: 'Lily: "Mommy, the shadow talks to me."', x: 2, z: -2 }
            ]},
            { id: 'guest', x: -10, z: -30, color: 0x223322, doors: ['hallway'], objects: [
                { type: 'note', text: 'Guest: "I heard crying from the walls."', x: 0, z: 2 }
            ]},
            { id: 'attic', x: -20, z: -20, color: 0x444444, doors: ['hallway'], objects: [
                { type: 'search', x: 0, z: -2, key: 'mirror', chance: 0.3, needs: 'crowbar' },
                { type: 'note', text: 'Thomas: "The mirror showed me her death."', x: 2, z: 2, easterEgg: 'Grok was our cat' }
            ]},
            { id: 'bathroom', x: -30, z: 0, color: 0x555555, doors: ['hallway'], objects: [
                { type: 'note', text: 'Clara: "Blood in the sink—Lily’s gone."', x: 2, z: -2 }
            ]},
            { id: 'balcony', x: -20, z: -30, color: 0x333333, doors: ['hallway'], objects: [
                { type: 'note', text: 'Edwin: "The stars aligned for our doom."', x: 0, z: 2 }
            ]},
            { id: 'cellar', x: 20, z: -10, color: 0x111111, doors: ['dining', 'ritual'], objects: [
                { type: 'key', x: 2, z: -2, key: 'crowbar' },
                { type: 'note', text: 'Servant: "The cellar hid our shame."', x: -2, z: 2 }
            ]},
            { id: 'ritual', x: 30, z: -10, color: 0x550000, doors: ['cellar', 'crypt'], objects: [
                { type: 'puzzle', x: 2, z: -2, clue: 'Fill chalice: Blood, Tears, Dust', key: 'chalice', solved: false },
                { type: 'note', text: 'Edwin: "The chalice binds us to it."', x: -2, z: 2 }
            ]},
            { id: 'storage', x: 20, z: -20, color: 0x222222, doors: ['cellar'], objects: [
                { type: 'note', text: 'Thomas: "I hid the dagger here once."', x: 2, z: -2 }
            ]},
            { id: 'boiler', x: 30, z: -20, color: 0x333333, doors: ['ritual'], objects: [
                { type: 'note', text: 'Worker: "The heat couldn’t burn the shadows."', x: 0, z: 2 }
            ]},
            { id: 'crypt', x: 40, z: -10, color: 0x111111, doors: ['ritual', 'vault'], objects: [
                { type: 'puzzle', x: 2, z: -2, clue: 'Ring’s code: LILY', key: 'ring', solved: false },
                { type: 'note', text: 'Clara: "Lily’s tomb is empty."', x: -2, z: 2 }
            ]},
            { id: 'wine', x: 40, z: 0, color: 0x442200, doors: ['cellar'], objects: [
                { type: 'note', text: 'Edwin: "Wine turned to ash in our mouths."', x: 2, z: -2 }
            ]},
            { id: 'workshop', x: 50, z: -10, color: 0x555555, doors: ['crypt'], objects: [
                { type: 'note', text: 'Thomas: "I forged a weapon, too late."', x: 2, z: -2, easterEgg: 'xAI graffiti on wall' }
            ]},
            { id: 'vault', x: 40, z: -20, color: 0x111111, doors: ['crypt'], objects: [
                { type: 'secret', x: 2, z: -2, key: 'shard', clue: 'All notes reveal the Wraith’s heart.' }
            ]},
            { id: 'lair', x: 50, z: -20, color: 0x000000, doors: [], objects: [
                { type: 'note', text: 'Lily: "Banish it, please..."', x: 0, z: 2 }
            ]}
        ];

        // Build rooms and objects
        const meshes = {};
        rooms.forEach(r => {
            const room = new THREE.Mesh(
                new THREE.BoxGeometry(10, 10, 10),
                new THREE.MeshBasicMaterial({ color: r.color, side: THREE.BackSide })
            );
            room.position.set(r.x, 0, r.z);
            scene.add(room);
            r.mesh = room;
            r.objects.forEach(obj => {
                if (obj.type === 'key' || obj.type === 'search' || obj.type === 'puzzle' || obj.type === 'secret') {
                    const mesh = new THREE.Mesh(
                        new THREE.SphereGeometry(0.3, 8, 8),
                        new THREE.MeshBasicMaterial({ color: 0xffff00 })
                    );
                    mesh.position.set(r.x + obj.x, -4, r.z + obj.z);
                    obj.mesh = mesh;
                    scene.add(mesh);
                } else if (obj.type === 'note') {
                    obj.pos = new THREE.Vector3(r.x + (obj.x || 0), -4, r.z + (obj.z || 0));
                }
            });
        });

        // Wraith and Lily
        const wraith = new THREE.Mesh(
            new THREE.CylinderGeometry(0.5, 0.5, 3, 8),
            new THREE.MeshBasicMaterial({ color: 0x111111 })
        );
        wraith.position.set(10, -4, -10);
        scene.add(wraith);

        const lily = new THREE.Mesh(
            new THREE.CylinderGeometry(0.3, 0.3, 1.5, 8),
            new THREE.MeshBasicMaterial({ color: 0xaaaaaa })
        );
        lily.position.set(-10, -4, 0);
        scene.add(lily);

        // Exit door
        const door = new THREE.Mesh(
            new THREE.PlaneGeometry(2, 4),
            new THREE.MeshBasicMaterial({ color: 0x550000 })
        );
        door.position.set(0, -2, -4.9);
        rooms[0].mesh.add(door);

        // Lighting
        const ambient = new THREE.AmbientLight(0x222222);
        scene.add(ambient);
        const pointLight = new THREE.PointLight(0xaaaaaa, 1, 20);
        pointLight.position.set(0, 0, 0);
        scene.add(pointLight);

        // Player state
        let currentRoom = rooms[0];
        camera.position.set(0, -2, 0);
        let inventory = [];
        let notes = [];
        let wraithSpeed = 0.005;
        let lilyTimer = 0;

        // Touch controls
        let startX, startY;
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const deltaX = e.touches[0].clientX - startX;
            const deltaY = e.touches[0].clientY - startY;
            camera.rotation.y -= deltaX * 0.005;
            const moveSpeed = 0.05;
            const newX = camera.position.x - Math.sin(camera.rotation.y) * (deltaY < -50 ? moveSpeed : deltaY > 50 ? -moveSpeed : 0);
            const newZ = camera.position.z - Math.cos(camera.rotation.y) * (deltaY < -50 ? moveSpeed : deltaY > 50 ? -moveSpeed : 0);
            if (Math.abs(newX - currentRoom.x) < 4 && Math.abs(newZ - currentRoom.z) < 4) {
                camera.position.x = newX;
                camera.position.z = newZ;
            }
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        canvas.addEventListener('touchend', (e) => {
            const x = e.changedTouches[0].clientX / window.innerWidth;
            const y = e.changedTouches[0].clientY / window.innerHeight;
            if (y > 0.8) interact();
            else if (x < 0.25 && currentRoom.doors[0]) goToRoom(currentRoom.doors[0]);
            else if (x > 0.25 && x < 0.5 && currentRoom.doors[1]) goToRoom(currentRoom.doors[1]);
            else if (x > 0.5 && x < 0.75 && currentRoom.doors[2]) goToRoom(currentRoom.doors[2]);
            else if (x > 0.75 && currentRoom.doors[3]) goToRoom(currentRoom.doors[3]);
        });

        function interact() {
            currentRoom.objects.forEach(obj => {
                if (obj.mesh && camera.position.distanceTo(obj.mesh.position) < 2) {
                    if (obj.type === 'key') {
                        inventory.push(obj.key);
                        scene.remove(obj.mesh);
                        showMessage(`You found ${obj.key}!`, false);
                        wraithSpeed += 0.005;
                    } else if (obj.type === 'search') {
                        if (obj.needs && !inventory.includes(obj.needs)) {
                            showMessage(`You need a ${obj.needs}.`, false);
                        } else if (Math.random() < obj.chance) {
                            inventory.push(obj.key);
                            scene.remove(obj.mesh);
                            showMessage(`You found ${obj.key}!`, false);
                            wraithSpeed += 0.005;
                        } else {
                            showMessage('Nothing here yet...', false);
                        }
                    } else if (obj.type === 'puzzle' && !obj.solved) {
                        if (obj.clue.includes('FEAR')) {
                            const idx = Math.floor(Math.random() * 4);
                            obj.state[idx] = true;
                            if (obj.state.every((s, i) => s === (obj.order.indexOf(i) !== -1))) {
                                obj.solved = true;
                                inventory.push(obj.key);
                                scene.remove(obj.mesh);
                                showMessage(`Puzzle solved! Found ${obj.key}.`, false);
                                wraithSpeed += 0.005;
                            } else if (obj.state.every(s => s)) {
                                obj.state = [false, false, false, false];
                                showMessage('Wrong order. Resetting...', false);
                            } else {
                                showMessage(obj.clue, false);
                            }
                        } else if (obj.clue.includes('1923') || obj.clue.includes('toys') || obj.clue.includes('chalice') || obj.clue.includes('LILY')) {
                            obj.solved = true;
                            inventory.push(obj.key);
                            scene.remove(obj.mesh);
                            showMessage(`Puzzle solved! Found ${obj.key}.`, false);
                            wraithSpeed += 0.005;
                        }
                    } else if (obj.type === 'secret' && notes.length >= 10) {
                        inventory.push(obj.key);
                        scene.remove(obj.mesh);
                        showMessage(`Secret unlocked! Found ${obj.key}.`, false);
                        goToRoom('lair');
                    }
                } else if (obj.type === 'note' && camera.position.distanceTo(obj.pos) < 2) {
                    showMessage(obj.text, false);
                    if (!notes.includes(obj.text)) {
                        notes.push(obj.text);
                        noteCountUI.innerText = notes.length;
                    }
                    if (obj.easterEgg) showMessage(obj.easterEgg, false);
                }
            });
            if (currentRoom.id === 'foyer' && camera.position.distanceTo(door.position) < 2 && inventory.length >= 10) {
                win();
            }
        }

        function goToRoom(roomId) {
            const newRoom = rooms.find(r => r.id === roomId);
            camera.position.set(newRoom.x, -2, newRoom.z);
            currentRoom = newRoom;
            pointLight.position.set(newRoom.x, 0, newRoom.z);
            if (Math.random() < 0.4) scare();
        }

        function scare() {
            const scares = [
                'Blood drips from the ceiling.',
                'A child’s cry echoes through the walls.',
                'The Wraith whispers: "Stay..."',
                'A chair slides across the floor.',
                'Claw marks appear on the wall.'
            ];
            showMessage(scares[Math.floor(Math.random() * scares.length)], true);
        }

        function animate() {
            requestAnimationFrame(animate);
            pointLight.intensity = 0.5 + Math.sin(Date.now() * 0.005) * 0.5;
            const targetRoom = rooms[Math.floor(Math.random() * rooms.length)];
            wraith.position.x += (targetRoom.x - wraith.position.x) * wraithSpeed;
            wraith.position.z += (targetRoom.z - wraith.position.z) * wraithSpeed;
            if (Math.random() < 0.05) wraith.position.set(camera.position.x + 5, -4, camera.position.z + 5);
            if (camera.position.distanceTo(wraith.position) < 1) lose();

            lilyTimer++;
            if (lilyTimer > 300 && Math.random() < 0.1) {
                lily.position.set(camera.position.x + 2, -4, camera.position.z + 2);
                showMessage('Lily’s ghost: "Help me..."', true);
                lilyTimer = 0;
            } else if (lilyTimer > 100) lily.position.set(-100, -4, -100); // Hide Lily

            renderer.render(scene, camera);
        }

        function showMessage(text, isScare = false) {
            message.innerText = text;
            message.style.color = isScare ? 'red' : 'white';
            message.style.display = 'block';
            setTimeout(() => message.style.display = 'none', 4000);
        }

        function win() {
            const ending = inventory.includes('shard') ? 'You banished the Wraith and freed the Hollows!' : 'You escaped, but the curse remains.';
            showMessage(ending);
            setTimeout(() => location.reload(), 2000);
        }

        function lose() {
            showMessage('The Wraith devoured your soul...');
            setTimeout(() => location.reload(), 2000);
        }

        showMessage('Uncover the Hollow Estate’s secrets. Find 10 artifacts to escape.');
        animate();
    </script>
</body>
</html>
